<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PARAMO Tutorial • SCATE.shortcourse</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="PARAMO Tutorial">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SCATE.shortcourse</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01_rphenoscape.html">RPhenoscape Tutorial</a>
    </li>
    <li>
      <a href="../articles/PARAMO.html">PARAMO Tutorial</a>
    </li>
    <li>
      <a href="../articles/glossary.html">Glossary</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/phenoscape/scate-shortcourse">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>PARAMO Tutorial</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/phenoscape/scate-shortcourse/blob/master/vignettes/PARAMO.Rmd"><code>vignettes/PARAMO.Rmd</code></a></small>
      <div class="hidden name"><code>PARAMO.Rmd</code></div>

    </div>

    
    
<p><img src="https://github.com/sergeitarasov/PARAMO/raw/master/icon-paramo.png"><!-- --></p>
<p><em><strong>P</strong>hylogenetic <strong>A</strong>ncestral <strong>R</strong>econstruction of <strong>A</strong>natomy by <strong>M</strong>apping <strong>O</strong>ntologies</em></p>
<p>The <span class="math inline">\(PARAMO\)</span> pipeline requires three initial pieces of data: a character matrix, a dated phylogeny, and an anatomy ontology. Herein, we use a set of 19 characters from OntoTrace and a large-scale phylogeny of fishes from <span class="citation">[@rabosky2018]</span>. In this demonstration, we are interested in constructing the amalgamated characters for the three levels of amalgamation (=anatomical hierarchy): anatomical dependencies (ADs), body regions (BRs) and entire phenotype (EF). At the BR level, three main body types are considered – “dermatocranium”, “paired fins” and “external integument structures”.</p>
<div id="step-1--initial-character-matrix" class="section level1">
<h1 class="hasAnchor">
<a href="#step-1--initial-character-matrix" class="anchor"></a>STEP 1. Initial character matrix</h1>
<p>We are going to retrieve our dataset from the Phenoscape Knowledgebase for demonstration purposes as our starting point. We are then going to reconstruct the history of these traits accounting for dependencies among them and amalgamating them according to trait type using the UBERON Anatomy Ontology.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Define our traits</span>
terms &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"dermatocranium"</span>, <span class="st">"paired fin"</span>, <span class="st">"barbel"</span>) 
<span class="co"># Define our taxon</span>
taxon &lt;-<span class="st"> "Siluriformes"</span>   

<span class="co"># Apply pk_get_ontotrace_xml over all our traits in our taxon of interest, the Siluriformes and retain</span>
<span class="co"># variable characters. If you want to return invariant characters instead, select variable_only=FALSE. </span>
nex &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(terms, pk_get_ontotrace_xml, <span class="dt">taxon=</span>taxon, <span class="dt">variable_only=</span><span class="ot">TRUE</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(nex) &lt;-<span class="st"> </span>terms

.m &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(nex, pk_get_ontotrace)

<span class="co"># Merge together the resulting 3 matrices and remove non-trait data (OTU identifiers) and duplicated columns (if present)</span>
m &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span>(.m, full_join, <span class="dt">by=</span><span class="st">"taxa"</span>, <span class="dt">suffix=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">""</span>, <span class="st">".y"</span>))  
m &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select_all.html">select_at</a></span>(m, dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span>(<span class="op">-</span><span class="kw">contains</span>(<span class="st">"otu"</span>))) <span class="co"># Removes otu data</span>
siluriformes &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select_all.html">select_at</a></span>(m, <span class="kw">vars</span>(<span class="op">-</span><span class="kw">contains</span>(<span class="st">".y"</span>))) <span class="co"># Removes duplicated columns</span>
<span class="kw"><a href="../reference/print_coverage.html">print_coverage</a></span>(siluriformes)</code></pre></div>
<p>To save time, simply run the line below rather than the chunk above.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(siluriformes)
<span class="kw"><a href="../reference/print_coverage.html">print_coverage</a></span>(siluriformes)</code></pre></div>
<pre><code>##                                             traits coverage     average
## 1                                     pectoral fin     1114 0.996409336
## 2                            pectoral fin skeleton     1114 0.996409336
## 3                      pectoral fin lepidotrichium     1073 0.996272134
## 4                               pectoral fin spine     1064 0.996240602
## 5                                 maxillary barbel     1027 0.998886414
## 6                                       pelvic fin      993 0.986788618
## 7                              pelvic fin skeleton      993 0.986788618
## 8                        pelvic fin lepidotrichium      949 0.979915433
## 9                                            vomer      828 0.924598269
## 10                                   entopterygoid      796 0.936446174
## 11                          posterior nasal barbel      788 0.591152815
## 12                                 coronomeckelian      750 0.936608558
## 13                                   mental barbel      748 0.827445652
## 14                                         urohyal      708 0.987270156
## 15                        pectoral fin radial bone      704 0.994318182
## 16                   pectoral fin radial cartilage      704 0.994318182
## 17                     pectoral fin radial element      704 0.994318182
## 18                    pectoral fin radial skeleton      704 0.994318182
## 19                                    interopercle      682 0.998502994
## 20                             outer mental barbel      677 0.754098361
## 21                             inner mental barbel      622 0.717990276
## 22                                  pelvic fin ray      583 0.967241379
## 23                                pelvic fin ray 1      581 0.967128028
## 24                         urohyal lateral process      563 0.899821109
## 25                                 lateropterygium      536 0.941619586
## 26                                  infraorbital 4      501 0.990000000
## 27                              ectopterygoid bone      435 0.647754137
## 28                  accessory vomerine tooth plate      412 0.207823961
## 29                                   pelvic splint      399 0.478149100
## 30                          urohyal median process      369 0.839673913
## 31                                   rostral plate      355 0.005633803
## 32               pectoral fin proximal radial bone      314 0.987261146
## 33          pectoral fin proximal radial cartilage      314 0.987261146
## 34            pectoral fin proximal radial element      314 0.987261146
## 35                                 suprapreopercle      309 0.770370370
## 36                          pelvic fin radial bone      304 0.009868421
## 37        anterior dentation of pectoral fin spine      289 0.691244240
## 38       posterior dentation of pectoral fin spine      284 0.867187500
## 39                           anterior nasal barbel      224 0.022321429
## 40                                pectoral fin ray      172 0.976744186
## 41                                     canal plate      132 0.901515152
## 42                       branched pectoral fin ray      108 0.962962963
## 43                                pelvic fin ray 6       98 0.775510204
## 44                 pectoral fin distal radial bone       81 0.950617284
## 45            pectoral fin distal radial cartilage       81 0.950617284
## 46              pectoral fin distal radial element       81 0.950617284
## 47             pectoral fin proximal radial bone 1       81 0.950617284
## 48             pectoral fin proximal radial bone 2       81 0.950617284
## 49        pectoral fin proximal radial cartilage 1       81 0.950617284
## 50        pectoral fin proximal radial cartilage 2       81 0.950617284
## 51          pectoral fin proximal radial element 1       81 0.950617284
## 52          pectoral fin proximal radial element 2       81 0.950617284
## 53               pectoral fin distal radial bone 2       80 0.950000000
## 54               pectoral fin distal radial bone 3       80 0.950000000
## 55          pectoral fin distal radial cartilage 2       80 0.950000000
## 56          pectoral fin distal radial cartilage 3       80 0.950000000
## 57            pectoral fin distal radial element 2       80 0.950000000
## 58            pectoral fin distal radial element 3       80 0.950000000
## 59                                      antorbital       78 0.974358974
## 60             pectoral fin proximal radial bone 3       71 0.943661972
## 61        pectoral fin proximal radial cartilage 3       71 0.943661972
## 62          pectoral fin proximal radial element 3       71 0.943661972
## 63                              pectoral fin ray 1       68 0.941176471
## 64                                   palatine bone       66 0.787878788
## 65                      preopercle horizontal limb       34 0.625000000
## 66 anterior distal serration of pectoral fin spine       26 0.809523810
## 67                       pelvic fin radial element       25 0.120000000
## 68                      pelvic fin radial skeleton       25 0.120000000
## 69                         pelvic radial cartilage       25 0.120000000</code></pre>
<p>The table that prints out shows the number of taxa for which there is data in the KB ( <em>coverage</em> ) and the proportion of taxa ( <em>average</em> ) that have this trait present (all of these are binary, presence/absence characters).</p>
<p>This dataset is too big for our demonstration purposes. So let’s filter down to a smaller set of traits that will illustrate our process.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(siluriformes,<span class="st">"taxa"</span>, 
              <span class="st">"vomer"</span>, <span class="st">"accessory vomerine tooth plate"</span>, <span class="st">"ectopterygoid bone"</span>,
              <span class="st">"mental barbel"</span>, <span class="st">"inner mental barbel"</span>, <span class="st">"outer mental barbel"</span>, <span class="st">"anterior nasal barbel"</span>, <span class="st">"posterior nasal barbel"</span>,
              <span class="st">"urohyal"</span>, <span class="st">"urohyal lateral process"</span>, <span class="st">"urohyal median process"</span>,
              <span class="st">"pectoral fin spine"</span>, <span class="st">"anterior dentation of pectoral fin spine"</span>, <span class="st">"posterior dentation of pectoral fin spine"</span>, 
              <span class="st">"pectoral fin"</span>,
              <span class="st">"pelvic fin"</span>, <span class="st">"pelvic splint"</span>, <span class="st">"pelvic fin ray"</span>
              )

## Let's also clean up some of the species names to only include Genus and species (drop subspecies etc.)
dat<span class="op">$</span>taxa &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unname">unname</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(dat<span class="op">$</span>taxa, <span class="cf">function</span>(x) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/strsplit">strsplit</a></span>(x, <span class="dt">split=</span><span class="st">" "</span>)[[<span class="dv">1</span>]][<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>], <span class="dt">collapse=</span><span class="st">"_"</span>)))

<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(dat)</code></pre></div>
<pre><code>##                            taxa   vomer accessory vomerine tooth plate
## 1            Acanthicus_hystrix 1 and 0                           &lt;NA&gt;
## 2     Acanthobunocephalus_nicoi       0                           &lt;NA&gt;
## 3      Acanthocleithron_chapini    &lt;NA&gt;                           &lt;NA&gt;
## 4        Acentronichthys_leptos       1                           &lt;NA&gt;
## 5           Acentronichthys_sp.       1                           &lt;NA&gt;
## 6 Acrochordonichthys_ischnosoma       1                           &lt;NA&gt;
##   ectopterygoid bone mental barbel inner mental barbel outer mental barbel
## 1               &lt;NA&gt;       0 and 1                   0                   0
## 2               &lt;NA&gt;             1                &lt;NA&gt;                &lt;NA&gt;
## 3               &lt;NA&gt;             1                   1                   1
## 4                  0          &lt;NA&gt;                &lt;NA&gt;                &lt;NA&gt;
## 5                  0          &lt;NA&gt;                &lt;NA&gt;                &lt;NA&gt;
## 6                  1          &lt;NA&gt;                &lt;NA&gt;                &lt;NA&gt;
##   anterior nasal barbel posterior nasal barbel urohyal
## 1                     0                      0       1
## 2                    NA                   &lt;NA&gt;       1
## 3                    NA                   &lt;NA&gt;       1
## 4                    NA                      0    &lt;NA&gt;
## 5                    NA                      0    &lt;NA&gt;
## 6                    NA                   &lt;NA&gt;       1
##   urohyal lateral process urohyal median process pectoral fin spine
## 1                    &lt;NA&gt;                   &lt;NA&gt;                  1
## 2                    &lt;NA&gt;                   &lt;NA&gt;                  1
## 3                    &lt;NA&gt;                   &lt;NA&gt;                  1
## 4                    &lt;NA&gt;                   &lt;NA&gt;                  1
## 5                    &lt;NA&gt;                   &lt;NA&gt;                  1
## 6                    &lt;NA&gt;                   &lt;NA&gt;                  1
##   anterior dentation of pectoral fin spine
## 1                                  1 and 0
## 2                                        1
## 3                                     &lt;NA&gt;
## 4                                     &lt;NA&gt;
## 5                                        1
## 6                                     &lt;NA&gt;
##   posterior dentation of pectoral fin spine pectoral fin pelvic fin
## 1                                      &lt;NA&gt;            1          1
## 2                                      &lt;NA&gt;            1       &lt;NA&gt;
## 3                                         1            1          1
## 4                                      &lt;NA&gt;            1          1
## 5                                   0 and 1            1          1
## 6                                      &lt;NA&gt;            1       &lt;NA&gt;
##   pelvic splint pelvic fin ray
## 1          &lt;NA&gt;              1
## 2          &lt;NA&gt;           &lt;NA&gt;
## 3             0           &lt;NA&gt;
## 4          &lt;NA&gt;              1
## 5          &lt;NA&gt;              1
## 6          &lt;NA&gt;           &lt;NA&gt;</code></pre>
<p>Now let’s load in the Rabosky fish phylogeny and match it to the data using <code>treeplyr</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(fishtree)
td &lt;-<span class="st"> </span><span class="kw">make.treedata</span>(fishtree, dat)
td</code></pre></div>
<pre><code>## $phy 
## 
## Phylogenetic tree with 474 tips and 473 internal nodes.
## 
## Tip labels:
##  Synodontis_victoriae, Synodontis_acanthomias, Synodontis_zambezensis, Synodontis_njassae, Synodontis_sorex, Synodontis_clarias, ...
## 
## Rooted; includes branch lengths.
## 
## $dat 
## # A tibble: 474 x 18
##    vomer `accessory vome… `ectopterygoid … `mental barbel` `inner mental b…
##    &lt;fct&gt; &lt;fct&gt;            &lt;fct&gt;            &lt;fct&gt;           &lt;fct&gt;           
##  1 &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;             1               1               
##  2 &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;             1               1               
##  3 &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;             1               1               
##  4 &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;             1               1               
##  5 &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;             1               1               
##  6 1     0                &lt;NA&gt;             1               1               
##  7 &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;             1               1               
##  8 &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;             1               1               
##  9 &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;             1               1               
## 10 &lt;NA&gt;  &lt;NA&gt;             &lt;NA&gt;             1               1               
## # … with 464 more rows, and 13 more variables: `outer mental
## #   barbel` &lt;fct&gt;, `anterior nasal barbel` &lt;int&gt;, `posterior nasal
## #   barbel` &lt;fct&gt;, urohyal &lt;fct&gt;, `urohyal lateral process` &lt;fct&gt;,
## #   `urohyal median process` &lt;fct&gt;, `pectoral fin spine` &lt;int&gt;, `anterior
## #   dentation of pectoral fin spine` &lt;fct&gt;, `posterior dentation of
## #   pectoral fin spine` &lt;fct&gt;, `pectoral fin` &lt;int&gt;, `pelvic fin` &lt;fct&gt;,
## #   `pelvic splint` &lt;fct&gt;, `pelvic fin ray` &lt;fct&gt;</code></pre>
<p>We want to learn about these traits, so we’re going to build a nice data table to see what these traits are and their unique identifiers using the KB API and <code>rphenoscape</code> function <code>pk_anatomical_detail</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">traits &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(td<span class="op">$</span>dat)
anatomical_details &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(traits, pk_anatomical_detail) <span class="co"># Query over traits and get anatomical details </span>

char_info &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>()
char_info<span class="op">$</span>ID &lt;-<span class="st"> </span>traits
char_info<span class="op">$</span>definition &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(anatomical_details, <span class="cf">function</span>(x) x<span class="op">$</span>definition) <span class="co"># Extract definitions</span>
char_info<span class="op">$</span>STATE_<span class="dv">0</span> &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(traits)) <span class="co"># All ontotrace matrices are binary presence/absence</span>
char_info<span class="op">$</span>STATE_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">1</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(traits)) <span class="co"># All ontotrace matrices are binary presence/absence</span>
char_info<span class="op">$</span>IRI &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(anatomical_details, <span class="cf">function</span>(x) x<span class="op">$</span>id) <span class="co"># Extra a unique URL identifier called an "IRI" </span>
char_info<span class="op">$</span>IRI &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">gsub</a></span>(<span class="st">"http://purl.obolibrary.org/obo/"</span>, <span class="st">""</span>, char_info<span class="op">$</span>IRI)
char_info<span class="op">$</span>IRI &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">gsub</a></span>(<span class="st">"_"</span>, <span class="st">":"</span>, char_info<span class="op">$</span>IRI)

char_info &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(char_info)
<span class="kw">as_tibble</span>(char_info)</code></pre></div>
<pre><code>## # A tibble: 18 x 5
##    ID                definition                     STATE_0 STATE_1 IRI    
##    &lt;fct&gt;             &lt;fct&gt;                            &lt;dbl&gt;   &lt;dbl&gt; &lt;fct&gt;  
##  1 vomer             the triangular flat bone of t…       0       1 UBERON…
##  2 accessory vomeri… Dermal bone that is located l…       0       1 UBERON…
##  3 ectopterygoid bo… A palatal bone which -- like …       0       1 UBERON…
##  4 mental barbel     Barbel that originates on the…       0       1 UBERON…
##  5 inner mental bar… Mental barbel that originates…       0       1 UBERON…
##  6 outer mental bar… Mental barbel that originates…       0       1 UBERON…
##  7 anterior nasal b… Barbel that is associated wit…       0       1 UBERON…
##  8 posterior nasal … Barbel that is attached to th…       0       1 UBERON…
##  9 urohyal           Tendon bone that forms in the…       0       1 UBERON…
## 10 urohyal lateral … Process that is part of the u…       0       1 UBERON…
## 11 urohyal median p… Process that is part of the u…       0       1 UBERON…
## 12 pectoral fin spi… Pectoral-fin lepidotrichium 1…       0       1 UBERON…
## 13 anterior dentati… Process that is tooth- or tho…       0       1 UBERON…
## 14 posterior dentat… Process that is tooth-like or…       0       1 UBERON…
## 15 pectoral fin      Paired fin that is located in…       0       1 UBERON…
## 16 pelvic fin        Paired fin located in the abd…       0       1 UBERON…
## 17 pelvic splint     Dermal bone that is located n…       0       1 UBERON…
## 18 pelvic fin ray    Soft ray that is part of the …       0       1 UBERON…</code></pre>
<p>We can construct a heat map that is organized by the semantic similarity of the traits to visualize our dataset. The phylogeny is displayed on the left side, and a tree of traits is on the top.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">njt &lt;-<span class="st"> </span><span class="kw"><a href="../reference/makeTraitTree.html">makeTraitTree</a></span>(td, <span class="dt">skip=</span><span class="ot">NULL</span>)
njt &lt;-<span class="st"> </span><span class="kw">root</span>(<span class="kw">multi2di</span>(njt), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">grep</a></span>(<span class="st">"barbel"</span>, njt<span class="op">$</span>tip.label))
<span class="kw"><a href="../reference/ontologyHeatMap.html">ontologyHeatMap</a></span>(td, njt, <span class="dt">start=</span><span class="dv">1</span>, <span class="dt">cex=</span><span class="fl">0.25</span>)</code></pre></div>
<pre><code>## Warning in recode.numeric(td$dat[[x]], `0 and 1` = 0.5, `1 and 0` = 0.5, :
## NAs introduced by coercion

## Warning in recode.numeric(td$dat[[x]], `0 and 1` = 0.5, `1 and 0` = 0.5, :
## NAs introduced by coercion

## Warning in recode.numeric(td$dat[[x]], `0 and 1` = 0.5, `1 and 0` = 0.5, :
## NAs introduced by coercion</code></pre>
<p><img src="PARAMO_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<pre><code>## NULL</code></pre>
<p>Some of our taxa are really data poor, so let’s filter them out and deal with a smaller, more manageable dataset by excluding all taxa that don’t have at least 40% of the traits as data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tdf &lt;-<span class="st"> </span><span class="kw"><a href="../reference/filter_coverage.html">filter_coverage</a></span>(td, <span class="dt">traits=</span><span class="dv">0</span>, <span class="dt">taxa=</span><span class="fl">0.4</span>)
njt &lt;-<span class="st"> </span><span class="kw"><a href="../reference/makeTraitTree.html">makeTraitTree</a></span>(tdf, <span class="dt">skip=</span><span class="ot">NULL</span>)
njt &lt;-<span class="st"> </span><span class="kw">root.phylo</span>(njt, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">grep</a></span>(<span class="st">"barbel"</span>, njt<span class="op">$</span>tip.label))
<span class="kw"><a href="../reference/ontologyHeatMap.html">ontologyHeatMap</a></span>(tdf, njt, <span class="dt">start=</span><span class="dv">1</span>, <span class="dt">cex=</span><span class="fl">0.25</span>)</code></pre></div>
<pre><code>## Warning in recode.numeric(td$dat[[x]], `0 and 1` = 0.5, `1 and 0` = 0.5, :
## NAs introduced by coercion

## Warning in recode.numeric(td$dat[[x]], `0 and 1` = 0.5, `1 and 0` = 0.5, :
## NAs introduced by coercion

## Warning in recode.numeric(td$dat[[x]], `0 and 1` = 0.5, `1 and 0` = 0.5, :
## NAs introduced by coercion</code></pre>
<p><img src="PARAMO_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<pre><code>## NULL</code></pre>
<p>Next, we want to identify the dependencies in our traits by using <code><a href="http://rphenoscape.phenoscape.org/reference/pa_dep_matrix.html">rphenoscape::pa_dep_matrix</a></code>, which returns a presence-absence dependency matrix when provided a list of terms. In other words, it returns which traits depend on the presence of another trait. This will be key information for building our evolutionary models, as not considering it can result in impossible ancestral state reconstructions and can also help the pseudoreplication that occurs when considering non-independent characters in phylogenetic analyses.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dep.mat &lt;-<span class="st"> </span><span class="kw">pa_dep_matrix</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">gsub</a></span>(<span class="st">"N:"</span>, <span class="st">"N_"</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"http://purl.obolibrary.org/obo/"</span>, char_info<span class="op">$</span>IRI, <span class="dt">sep=</span><span class="st">""</span>)), <span class="dt">.names=</span><span class="st">"label"</span>, <span class="dt">preserveOrder=</span><span class="ot">TRUE</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/diag">diag</a></span>(dep.mat) &lt;-<span class="st"> </span><span class="ot">NA</span>
G1 &lt;-<span class="st"> </span>igraph<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/igraph/topics/graph_from_adjacency_matrix">graph_from_adjacency_matrix</a></span>(<span class="kw"><a href="../reference/remove_indirect.html">remove_indirect</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/t">t</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">as.matrix</a></span>(dep.mat))))

con.comp &lt;-<span class="st"> </span>igraph<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/igraph/topics/components">components</a></span>(G1, <span class="st">"weak"</span>) <span class="co"># Organizes the subgraphs within our graph and allows us to pick out connected pieces</span>


<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(G1, <span class="dt">vertex.size=</span><span class="dv">5</span>, <span class="dt">edge.arrow.size=</span><span class="fl">0.5</span>, <span class="dt">vertex.label.cex=</span><span class="fl">0.75</span>)</code></pre></div>
<p><img src="PARAMO_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pf.group &lt;-<span class="st"> </span>con.comp<span class="op">$</span>membership[<span class="st">"pectoral fin"</span>] ## Which group contains "pectoral fin"
pf.Graph &lt;-<span class="st"> </span>igraph<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/igraph/topics/subgraph">induced_subgraph</a></span>(G1, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(con.comp<span class="op">$</span>membership<span class="op">==</span>pf.group)) ## Pick out the subgraph with "pectoral fin"
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(pf.Graph, <span class="dt">vertex.label.cex=</span><span class="fl">0.75</span>)</code></pre></div>
<p><img src="PARAMO_files/figure-html/unnamed-chunk-9-2.png" width="700"> In the dependency graph above, for example, you can see that the presence of the pectoral fin spine is dependent on the presence of the pectoral fin.</p>
<p>Now we can build in our dependencies into our evolutionary models by amalgamating characters based on their dependency structure (pulled from the graph).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">amal.deps &lt;-<span class="st"> </span><span class="kw"><a href="../reference/amalgamate_deps.html">amalgamate_deps</a></span>(dep.mat) ## Create an object of transition matrices for the amalgamated characters
td.comb &lt;-<span class="st"> </span><span class="kw"><a href="../reference/recode_traits.html">recode_traits</a></span>(tdf, amal.deps) ## Recode the original dataset according to the character states of the new, amalgamated characters (with Hidden states)</code></pre></div>
<p>If the above code didn’t work for you, you can catch up by loading this dataset from the <code>scate-shortcourse</code> package</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(td.comb)</code></pre></div>
<p>We can reconstruct our stochastic character maps by first fitting the model in the R package <code>corHMM</code>, then using the model fit to generate stochastic maps in <code>phytools</code>. In the workshop, we will do a Julia Child-style switch-a-roo and analyze completed analyses, rather than actually running these, because they will take too long.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## <span class="al">WARNING</span>: VERY TIME CONSUMING (~15-30 minutes)
corhmm.fits &lt;-<span class="st"> </span><span class="kw"><a href="../reference/amalgamated_fits_corHMM.html">amalgamated_fits_corHMM</a></span>(td.comb, amal.deps)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(corhmm.fits)
trees &lt;-<span class="st"> </span><span class="kw"><a href="../reference/amalgamated_simmaps_phytools.html">amalgamated_simmaps_phytools</a></span>(corhmm.fits, <span class="dt">nsim=</span><span class="dv">2</span>) <span class="co"># Create 2 stochastic character maps per character</span></code></pre></div>
<pre><code>## make.simmap is sampling character histories conditioned on the transition matrix
## 
## Q =
##              0            1
## 0 -0.015181962  0.015181962
## 1  0.000439188 -0.000439188
## (specified by the user);
## and (mean) root node prior probabilities
## pi =
##          0          1 
## 0.08538509 0.91461491</code></pre>
<pre><code>## Done.</code></pre>
<pre><code>## make.simmap is sampling character histories conditioned on the transition matrix
## 
## Q =
##              0            1
## 0 -0.001262416  0.001262416
## 1  0.005320256 -0.005320256
## (specified by the user);
## and (mean) root node prior probabilities
## pi =
##          0          1 
## 0.98917784 0.01082216</code></pre>
<pre><code>## Done.</code></pre>
<pre><code>## make.simmap is sampling character histories conditioned on the transition matrix
## 
## Q =
##              0            1
## 0 -0.005602360  0.005602360
## 1  0.001354655 -0.001354655
## (specified by the user);
## and (mean) root node prior probabilities
## pi =
##           0           1 
## 0.998542608 0.001457392</code></pre>
<pre><code>## Done.</code></pre>
<pre><code>## make.simmap is sampling character histories conditioned on the transition matrix
## 
## Q =
##              0            1            2            3            4
## 0 -0.001580976  0.000000000  0.000000000  0.000000000  0.001580976
## 1  0.000000000 -0.001580976  0.000000000  0.000000000  0.000000000
## 2  0.000000000  0.000000000 -0.001580976  0.000000000  0.000000000
## 3  0.000000000  0.000000000  0.000000000 -0.001580976  0.000000000
## 4  0.000000000  0.000000000  0.000000000  0.000000000 -0.618379378
## 5  0.000000000  0.000000000  0.000000000  0.000000000  0.003743554
## 6  0.000000000  0.000000000  0.000000000  0.000000000  0.007070156
## 7  0.000000000  0.000000000  0.000000000  0.000000000  0.000000000
##              5            6            7
## 0  0.000000000  0.000000000  0.000000000
## 1  0.001580976  0.000000000  0.000000000
## 2  0.000000000  0.001580976  0.000000000
## 3  0.000000000  0.000000000  0.001580976
## 4  0.323162692  0.295216686  0.000000000
## 5 -0.298960240  0.000000000  0.295216686
## 6  0.000000000 -0.330232848  0.323162692
## 7  0.007070156  0.003743554 -0.010813710
## (specified by the user);
## and (mean) root node prior probabilities
## pi =
##            0            1            2            3            4 
## 1.000000e+00 7.655106e-09 1.385522e-08 1.179111e-09 2.391490e-08 
##            5            6            7 
## 5.143241e-11 9.325065e-11 1.211850e-12</code></pre>
<pre><code>## Done.</code></pre>
<pre><code>## make.simmap is sampling character histories conditioned on the transition matrix
## 
## Q =
##               0            1
## 0 -0.0007914947 0.0007914947
## 1  0.0000000000 0.0000000000
## (specified by the user);
## and (mean) root node prior probabilities
## pi =
##            0            1 
## 1.000000e+00 4.487579e-08</code></pre>
<pre><code>## Done.</code></pre>
<pre><code>## make.simmap is sampling character histories conditioned on the transition matrix
## 
## Q =
##              0            1
## 0 -0.005096552  0.005096552
## 1  0.002356203 -0.002356203
## (specified by the user);
## and (mean) root node prior probabilities
## pi =
##         0         1 
## 0.8156332 0.1843668</code></pre>
<pre><code>## Done.</code></pre>
<pre><code>## make.simmap is sampling character histories conditioned on the transition matrix
## 
## Q =
##            0          1          2          3             4             5
## 0 -0.2422633  0.0000000  0.0000000  0.0000000  0.2422632522  0.0000000000
## 1  0.0000000 -0.2422633  0.0000000  0.0000000  0.0000000000  0.2422632522
## 2  0.0000000  0.0000000 -0.2422633  0.0000000  0.0000000000  0.0000000000
## 3  0.0000000  0.0000000  0.0000000 -0.2422633  0.0000000000  0.0000000000
## 4  0.0000000  0.0000000  0.0000000  0.0000000 -0.0075404502  0.0000000000
## 5  0.0000000  0.0000000  0.0000000  0.0000000  0.0004123124 -0.0079527625
## 6  0.0000000  0.0000000  0.0000000  0.0000000  0.0004200246  0.0000000000
## 7  0.0000000  0.0000000  0.0000000  0.0000000  0.0000000000  0.0004200246
##               6            7
## 0  0.0000000000  0.000000000
## 1  0.0000000000  0.000000000
## 2  0.2422632522  0.000000000
## 3  0.0000000000  0.242263252
## 4  0.0075404502  0.000000000
## 5  0.0000000000  0.007540450
## 6 -0.0004200246  0.000000000
## 7  0.0004123124 -0.000832337
## (specified by the user);
## and (mean) root node prior probabilities
## pi =
##            0            1            2            3            4 
## 6.343138e-19 6.397440e-03 3.236837e-17 4.926197e-01 4.868857e-11 
##            5            6            7 
## 1.180867e-02 2.016923e-09 4.891742e-01</code></pre>
<pre><code>## Done.</code></pre>
<pre><code>## make.simmap is sampling character histories conditioned on the transition matrix
## 
## Q =
##                0             1            10            11           12
## 0  -0.0002936557  0.0000000000  0.0000000000  0.0000000000  0.000000000
## 1   0.0000000000 -0.0002936557  0.0000000000  0.0000000000  0.000000000
## 10  0.0000000000  0.0000000000 -0.0002936557  0.0000000000  0.000000000
## 11  0.0000000000  0.0000000000  0.0000000000 -0.0002936557  0.000000000
## 12  0.0000000000  0.0000000000  0.0000000000  0.0000000000 -0.045575315
## 13  0.0000000000  0.0000000000  0.0000000000  0.0000000000  0.000000000
## 14  0.0000000000  0.0000000000  0.0000000000  0.0000000000  0.006548259
## 15  0.0000000000  0.0000000000  0.0000000000  0.0000000000  0.000000000
## 2   0.2297699449  0.0000000000  0.0000000000  0.0000000000  0.000000000
## 3   0.0000000000  0.2297699449  0.0000000000  0.0000000000  0.000000000
## 4   0.0000000000  0.0000000000  0.2297699449  0.0000000000  0.000000000
## 5   0.0000000000  0.0000000000  0.0000000000  0.2297699449  0.000000000
## 6   0.0000000000  0.0000000000  0.0000000000  0.0000000000  0.229769945
## 7   0.0000000000  0.0000000000  0.0000000000  0.0000000000  0.000000000
## 8   0.0000000000  0.0000000000  0.0000000000  0.0000000000  0.000000000
## 9   0.0000000000  0.0000000000  0.0000000000  0.0000000000  0.000000000
##              13          14           15             2             3
## 0   0.000000000  0.00000000  0.000000000  0.0002936557  0.0000000000
## 1   0.000000000  0.00000000  0.000000000  0.0000000000  0.0002936557
## 10  0.000000000  0.00000000  0.000000000  0.0000000000  0.0000000000
## 11  0.000000000  0.00000000  0.000000000  0.0000000000  0.0000000000
## 12  0.024642662  0.02063900  0.000000000  0.0000000000  0.0000000000
## 13 -0.020932653  0.00000000  0.020638998  0.0000000000  0.0000000000
## 14  0.000000000 -0.03148458  0.024642662  0.0000000000  0.0000000000
## 15  0.006548259  0.00000000 -0.006841915  0.0000000000  0.0000000000
## 2   0.000000000  0.00000000  0.000000000 -0.7412377583  0.0000000000
## 3   0.000000000  0.00000000  0.000000000  0.0000000000 -0.7412377583
## 4   0.000000000  0.00000000  0.000000000  0.0000000000  0.0000000000
## 5   0.000000000  0.00000000  0.000000000  0.0000000000  0.0000000000
## 6   0.000000000  0.00000000  0.000000000  0.3763825953  0.0000000000
## 7   0.229769945  0.00000000  0.000000000  0.0000000000  0.3763825953
## 8   0.000000000  0.22976994  0.000000000  0.0000000000  0.0000000000
## 9   0.000000000  0.00000000  0.229769945  0.0000000000  0.0000000000
##                4             5             6             7             8
## 0   0.0000000000  0.0000000000  0.0000000000  0.0000000000  0.0000000000
## 1   0.0000000000  0.0000000000  0.0000000000  0.0000000000  0.0000000000
## 10  0.0002936557  0.0000000000  0.0000000000  0.0000000000  0.0000000000
## 11  0.0000000000  0.0002936557  0.0000000000  0.0000000000  0.0000000000
## 12  0.0000000000  0.0000000000  0.0002936557  0.0000000000  0.0000000000
## 13  0.0000000000  0.0000000000  0.0000000000  0.0002936557  0.0000000000
## 14  0.0000000000  0.0000000000  0.0000000000  0.0000000000  0.0002936557
## 15  0.0000000000  0.0000000000  0.0000000000  0.0000000000  0.0000000000
## 2   0.0000000000  0.0000000000  0.5114678135  0.0000000000  0.0000000000
## 3   0.0000000000  0.0000000000  0.0000000000  0.5114678135  0.0000000000
## 4  -0.7412377583  0.0000000000  0.0000000000  0.0000000000  0.5114678135
## 5   0.0000000000 -0.7412377583  0.0000000000  0.0000000000  0.0000000000
## 6   0.0000000000  0.0000000000 -0.6514341999  0.0246426622  0.0206389975
## 7   0.0000000000  0.0000000000  0.0000000000 -0.6267915377  0.0000000000
## 8   0.3763825953  0.0000000000  0.0065482591  0.0000000000 -0.6373434615
## 9   0.0000000000  0.3763825953  0.0000000000  0.0065482591  0.0000000000
##                9
## 0   0.0000000000
## 1   0.0000000000
## 10  0.0000000000
## 11  0.0000000000
## 12  0.0000000000
## 13  0.0000000000
## 14  0.0000000000
## 15  0.0002936557
## 2   0.0000000000
## 3   0.0000000000
## 4   0.0000000000
## 5   0.5114678135
## 6   0.0000000000
## 7   0.0206389975
## 8   0.0246426622
## 9  -0.6127007993
## (specified by the user);
## and (mean) root node prior probabilities
## pi =
##            0            1           10           11           12 
## 8.390665e-07 6.130776e-14 1.046516e-06 7.638700e-14 2.969643e-01 
##           13           14           15            2            3 
## 9.079284e-08 3.631342e-01 1.110233e-07 4.616034e-02 2.598839e-09 
##            4            5            6            7            8 
## 5.705092e-02 3.209243e-09 1.062751e-01 3.240113e-08 1.304130e-01 
##            9 
## 3.975679e-08</code></pre>
<pre><code>## Done.</code></pre>
<pre><code>## make.simmap is sampling character histories conditioned on the transition matrix
## 
## Q =
##            0          1          2          3          4            5
## 0 -0.8152564  0.0000000  0.0000000  0.0000000  0.8152564  0.000000000
## 1  0.0000000 -0.8152564  0.0000000  0.0000000  0.0000000  0.815256398
## 2  0.0000000  0.0000000 -0.8152564  0.0000000  0.0000000  0.000000000
## 3  0.0000000  0.0000000  0.0000000 -0.8152564  0.0000000  0.000000000
## 4  0.0000000  0.0000000  0.0000000  0.0000000 -3.1339064  3.127180986
## 5  0.0000000  0.0000000  0.0000000  0.0000000  0.0000000 -0.006725387
## 6  0.0000000  0.0000000  0.0000000  0.0000000  0.0000000  0.000000000
## 7  0.0000000  0.0000000  0.0000000  0.0000000  0.0000000  0.000000000
##              6           7
## 0  0.000000000 0.000000000
## 1  0.000000000 0.000000000
## 2  0.815256398 0.000000000
## 3  0.000000000 0.815256398
## 4  0.006725387 0.000000000
## 5  0.000000000 0.006725387
## 6 -3.127180986 3.127180986
## 7  0.000000000 0.000000000
## (specified by the user);
## and (mean) root node prior probabilities
## pi =
##            0            1            2            3            4 
## 2.507703e-01 2.507703e-01 2.791046e-08 2.791046e-08 2.492219e-01 
##            5            6            7 
## 2.492375e-01 4.496398e-08 4.496679e-08</code></pre>
<pre><code>## Done.</code></pre>
<p>We can plot these simmap trees immediately and see what it looks like, we will do this again shortly with prettier labeling and colors.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfrow=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">3</span>,<span class="dv">3</span>))
<span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(trees)){
  states &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">ncol</a></span>(corhmm.fits[[i]]<span class="op">$</span>index.mat)
  phytools<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/phytools/topics/plotSimmap">plotSimmap</a></span>(trees[[i]][[<span class="dv">1</span>]], <span class="dt">ftype=</span><span class="st">"off"</span>)
}</code></pre></div>
<pre><code>## no colors provided. using the following legend:
##       0       1 
## "black"   "red"</code></pre>
<pre><code>## no colors provided. using the following legend:
##       0       1 
## "black"   "red"</code></pre>
<pre><code>## no colors provided. using the following legend:
##       0       1 
## "black"   "red"</code></pre>
<pre><code>## no colors provided. using the following legend:
##        0        4        5        6        7 
##  "black"    "red" "green3"   "blue"   "cyan"</code></pre>
<pre><code>## no colors provided. using the following legend:
##       0       1 
## "black"   "red"</code></pre>
<pre><code>## no colors provided. using the following legend:
##       0       1 
## "black"   "red"</code></pre>
<pre><code>## no colors provided. using the following legend:
##        4        5        6        7 
##  "black"    "red" "green3"   "blue"</code></pre>
<pre><code>## no colors provided. using the following legend:
##         0        12        13        14        15         2         6 
##   "black"     "red"  "green3"    "blue"    "cyan" "magenta"  "yellow"</code></pre>
<pre><code>## no colors provided. using the following legend:
##        0        4        5        7 
##  "black"    "red" "green3"   "blue"</code></pre>
<p><img src="PARAMO_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>Our next step is to aggregate the traits by their trait types. This part is not quite done by the phenoscape API, so we’re going to interact directly with the UBERON ontology. In the future, this will not be necessary. To construct manually, you simply need to provide a list of how you want the traits aggregated.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># let's modify our character info to drop dependent states and match our new amalgamated characters</span>
char_info_comb &lt;-<span class="st"> </span><span class="kw"><a href="../reference/dropDependentTraits.html">dropDependentTraits</a></span>(char_info, dep.mat, td.comb)
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(UBERON)
BR_names &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"dermatocranium"</span>, <span class="st">"paired fin"</span>, <span class="st">"external integument structure"</span>)
EF_names &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"anatomical structure"</span>)

BR &lt;-<span class="st"> </span><span class="kw"><a href="../reference/RAC_query.html">RAC_query</a></span>(char_info_comb, UBERON, BR_names)</code></pre></div>
<pre><code>## Warning in parts$IRI &lt;- sapply(parts[, 1], strip_IRI): Coercing LHS to a
## list</code></pre>
<pre><code>## 
## Aggregations by :
## $dermatocranium
## [1] "vomer"                                                 
## [2] "accessory vomerine tooth plate"                        
## [3] "ectopterygoid bone"                                    
## [4] "urohyal+urohyal lateral process+urohyal median process"
## 
## $`paired fin`
## [1] "pectoral fin+pectoral fin spine+anterior dentation of pectoral fin spine+posterior dentation of pectoral fin spine"
## [2] "pelvic fin+pelvic splint+pelvic fin ray"                                                                           
## 
## $`external integument structure`
## [1] "mental barbel+inner mental barbel+outer mental barbel"
## [2] "anterior nasal barbel"                                
## [3] "posterior nasal barbel"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">EF &lt;-<span class="st"> </span><span class="kw"><a href="../reference/RAC_query.html">RAC_query</a></span>(char_info_comb, UBERON, EF_names)</code></pre></div>
<pre><code>## Warning in parts$IRI &lt;- sapply(parts[, 1], strip_IRI): Coercing LHS to a
## list</code></pre>
<pre><code>## 
## Aggregations by :
## $`anatomical structure`
## [1] "vomer"                                                                                                             
## [2] "accessory vomerine tooth plate"                                                                                    
## [3] "ectopterygoid bone"                                                                                                
## [4] "mental barbel+inner mental barbel+outer mental barbel"                                                             
## [5] "anterior nasal barbel"                                                                                             
## [6] "posterior nasal barbel"                                                                                            
## [7] "urohyal+urohyal lateral process+urohyal median process"                                                            
## [8] "pectoral fin+pectoral fin spine+anterior dentation of pectoral fin spine+posterior dentation of pectoral fin spine"
## [9] "pelvic fin+pelvic splint+pelvic fin ray"</code></pre>
<p>This next section stacks stochastic character maps by aggregation level, making new amalgamated super-characters. We do this at 3 levels.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">#############
<span class="co"># Individual characters</span>
#############
<span class="co"># This is a function to processes the individual rayDISC maps produced by corHMM and discretizes the maps to ease amalgamation. </span>
<span class="co"># For individual characters, no additional processing is necessary</span>
IND.maps &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prepareMapsRayDISC.html">prepareMapsRayDISC</a></span>(td.comb, trees, <span class="dt">discretization_level=</span><span class="dv">100</span>)


#############
<span class="co"># Amalgamation at the BR level</span>
#############
<span class="co"># we use the ouput `BR` from the RAC query obtained at Step 3. </span>
<span class="co"># This ouput contains character IDs for BR terms</span>
<span class="co"># Let's rename those IDs to match the file names of the stochastic maps</span>
cc2 &lt;-<span class="st"> </span>BR
cc2 &lt;-<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(cc2, <span class="cf">function</span>(x) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">gsub</a></span>(<span class="st">" "</span>, <span class="st">"_"</span>, x) )

<span class="co"># creating BR.maps to store the amalagamations</span>
BR.maps&lt;-<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/vector">vector</a></span>(<span class="st">"list"</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(BR))
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(BR.maps)&lt;-<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(BR)

<span class="co"># run amalgamation using the renamed outputs from RAC query</span>
<span class="co"># this loop construct one amalgamation for each BR term</span>
<span class="co"># the number of amalgamations per term can be specified using `ntrees=`</span>
<span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(BR.maps))
{
  map&lt;-<span class="kw"><a href="../reference/paramo.list.html">paramo.list</a></span>(cc2[[i]], IND.maps, <span class="dt">ntrees=</span><span class="dv">2</span>)
  BR.maps[[i]]&lt;-map
}

#############
<span class="co"># Amalgamation at the EF level</span>
#############
<span class="co"># we use the ouput `EF` from the RAC query obtained at Step 3. </span>
<span class="co"># This ouput contains character IDs for EF term</span>
<span class="co"># Let's rename those IDs to match the file names of the stochastic maps</span>
cc3 &lt;-<span class="st"> </span>EF
cc3 &lt;-<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(cc3, <span class="cf">function</span>(x) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">gsub</a></span>(<span class="st">" "</span>, <span class="st">"_"</span>, x) )

<span class="co"># creating EF.maps to store the amalagamations</span>
EF.maps&lt;-<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/vector">vector</a></span>(<span class="st">"list"</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(EF))
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(EF.maps)&lt;-<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(EF)

<span class="co"># run amalgamation using the renamed outputs from RAC query</span>
<span class="co"># this code will return 1 amalgamated stochastic map of the EF character</span>
<span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(EF.maps))
{
  map&lt;-<span class="kw"><a href="../reference/paramo.list.html">paramo.list</a></span>(cc3[[i]], IND.maps, <span class="dt">ntrees=</span><span class="dv">2</span>)
  EF.maps[[i]]&lt;-map
}</code></pre></div>
<p>If you skipped the steps above, no problem, we can simply load the pre-cooked data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(IND.maps)
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(EF.maps)
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(BR.maps)</code></pre></div>
<p>Let’s plot and view the results!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">#########
<span class="co"># Individual Traits Level</span>
########
<span class="co"># Set up a pretty color palette</span>
hm.palette &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/colorRamp">colorRampPalette</a></span>(RColorBrewer<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/RColorBrewer/topics/ColorBrewer">brewer.pal</a></span>(<span class="dv">9</span>, <span class="st">'Set1'</span>), <span class="dt">space=</span><span class="st">'Lab'</span>)

<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfrow=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>,<span class="dv">2</span>))
ymax &lt;-<span class="st"> </span><span class="fl">1.1</span><span class="op">*</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(td.comb<span class="op">$</span>phy<span class="op">$</span>tip.label) <span class="co">#set our boundaries for our plot area</span>
<span class="cf">for</span>(i <span class="cf">in</span> (<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(char_info_comb<span class="op">$</span>ID))){
  trait &lt;-<span class="st"> </span>char_info_comb<span class="op">$</span>ID[i]
  trait &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">gsub</a></span>(<span class="st">" "</span>, <span class="st">"_"</span>, trait)
  <span class="co">#map &lt;- paramo(trait, ntrees=1, dirW=dirW)</span>
  map &lt;-<span class="st"> </span>IND.maps[[trait]]
  states &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unlist">unlist</a></span>(map[[<span class="dv">1</span>]]<span class="op">$</span>maps)))
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(states)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/try">try</a></span>(phytools<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/phytools/topics/plotSimmap">plotSimmap</a></span>(map[[<span class="dv">1</span>]], <span class="dt">pts=</span>F,<span class="dt">ftype=</span><span class="st">"off"</span>, <span class="dt">colors=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/setNames">setNames</a></span>(<span class="kw">hm.palette</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(states)), states), <span class="dt">ylim=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, ymax)))
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/title">title</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"</span><span class="ch">\n\n</span><span class="st"> "</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">gsub</a></span>(<span class="st">"_"</span>, <span class="st">" "</span>, trait)), <span class="dt">cex.main=</span><span class="fl">0.8</span>)
}</code></pre></div>
<pre><code>## [1] "1" "0"</code></pre>
<pre><code>## [1] "0" "1"</code></pre>
<p><img src="PARAMO_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
<pre><code>## [1] "0" "1"</code></pre>
<pre><code>## [1] "0" "4" "6" "7" "5"</code></pre>
<p><img src="PARAMO_files/figure-html/unnamed-chunk-18-2.png" width="700"></p>
<pre><code>## [1] "0" "1"</code></pre>
<pre><code>## [1] "0" "1"</code></pre>
<p><img src="PARAMO_files/figure-html/unnamed-chunk-18-3.png" width="700"></p>
<pre><code>## [1] "7" "5" "4" "6"</code></pre>
<pre><code>##  [1] "15" "14" "13" "5"  "9"  "7"  "12" "6"  "2"  "0"  "8"</code></pre>
<p><img src="PARAMO_files/figure-html/unnamed-chunk-18-4.png" width="700"></p>
<pre><code>## [1] "5" "7"</code></pre>
<p><img src="PARAMO_files/figure-html/unnamed-chunk-18-5.png" width="700"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">#########
<span class="co"># BR level</span>
########
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfrow=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>,<span class="dv">3</span>))

<span class="co"># plot one stochastic maps for the head character</span>
states &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unlist">unlist</a></span>(BR.maps<span class="op">$</span>dermatocranium[[<span class="dv">1</span>]]<span class="op">$</span>maps)))
phytools<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/phytools/topics/plotSimmap">plotSimmap</a></span>(BR.maps<span class="op">$</span>dermatocranium[[<span class="dv">1</span>]], <span class="dt">pts=</span>F,<span class="dt">ftype=</span><span class="st">"off"</span>,  <span class="dt">colors=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/setNames">setNames</a></span>(<span class="kw">hm.palette</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(states)), states))
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/title">title</a></span>(<span class="st">"</span><span class="ch">\n</span><span class="st"> Dermatocranium character"</span>)

<span class="co"># plot one stochastic maps for the wings character</span>
states &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unlist">unlist</a></span>(BR.maps<span class="op">$</span><span class="st">'paired fin'</span>[[<span class="dv">1</span>]]<span class="op">$</span>maps)))
phytools<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/phytools/topics/plotSimmap">plotSimmap</a></span>(BR.maps<span class="op">$</span><span class="st">`</span><span class="dt">paired fin</span><span class="st">`</span>[[<span class="dv">1</span>]], <span class="dt">pts=</span>F,<span class="dt">ftype=</span><span class="st">"off"</span>, <span class="dt">colors=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/setNames">setNames</a></span>(<span class="kw">hm.palette</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(states)), states) )
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/title">title</a></span>(<span class="st">"</span><span class="ch">\n</span><span class="st"> Paired Fin character"</span>)

<span class="co"># plot one stochastic maps for the legs character</span>
states &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unlist">unlist</a></span>(BR.maps<span class="op">$</span><span class="st">`</span><span class="dt">external integument structure</span><span class="st">`</span>[[<span class="dv">1</span>]]<span class="op">$</span>maps)))
phytools<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/phytools/topics/plotSimmap">plotSimmap</a></span>(BR.maps<span class="op">$</span><span class="st">`</span><span class="dt">external integument structure</span><span class="st">`</span>[[<span class="dv">1</span>]], <span class="dt">pts=</span>F,<span class="dt">ftype=</span><span class="st">"off"</span>, <span class="dt">colors=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/setNames">setNames</a></span>(<span class="kw">hm.palette</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(states)), states))
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/title">title</a></span>(<span class="st">"</span><span class="ch">\n</span><span class="st"> Barbel character"</span>)</code></pre></div>
<p><img src="PARAMO_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">#########
<span class="co"># EF level</span>
#########
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfrow=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>,<span class="dv">3</span>))
<span class="co"># plot one stochastic maps for the entire phenotype character</span>
<span class="co"># first, let's define color pallette for the characters since it contains many states</span>
tmm&lt;-EF.maps[[<span class="dv">1</span>]][[<span class="dv">1</span>]]
states &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unlist">unlist</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(tmm<span class="op">$</span>maps, names)))
<span class="co"># number of states in the character</span>
<span class="co">#length(states)</span>

color&lt;-<span class="kw">hm.palette</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(states))

phytools<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/phytools/topics/plotSimmap">plotSimmap</a></span>(tmm, <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/setNames">setNames</a></span>(color, states),  <span class="dt">lwd=</span><span class="dv">3</span>, <span class="dt">pts=</span>F,<span class="dt">ftype=</span><span class="st">"off"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/title">title</a></span>(<span class="st">"</span><span class="ch">\n</span><span class="st"> Entire Phenotype character"</span>)</code></pre></div>
<p><img src="PARAMO_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#step-1--initial-character-matrix">STEP 1. Initial character matrix</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Hilmar Lapp, Wasila Dahdul, Josef Uyeda.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
